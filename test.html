<html>
    <header>
        <link rel="stylesheet" type="text/css" href="css/datatables.min.css"/>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>

        <script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/parameter.js"></script>
        <script src="js/alasql.js"></script>
        <script src="js/ala_test.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/datatables.min.js"></script>
    </header>

    <style>
      table {
        width: 100%;
        border: 1px solid #000000;
      }
      th, td {
        border: 1px solid #000000;
          height: 15px;
          text-align: center;
      }
    </style>

    <body>
        <div id="test">
        </div>
    </body>
    <script type="text/javascript">
        $(document).ready(function() {
            var row_field = ["row_val", "row_val_1"];
            var col_field = ["col_val", "col_val_1"];
            var aggregation_field = [{
                field: "revenue",
                calculate: "sum"
            },{
                field: "revenue",
                calculate: "avg"
            }]

            // pivot cell 에 넣을 data
            var result_list = getPivotQry(row_field, col_field, aggregation_field);

            // pivot row 의 distinct data
            var row_list = getDistinctQry(row_field);

            // pivot column 의 distinct data
            var col_list = getDistinctQry(col_field);

            // pivot mapping cell
            var mapping_cell = setCellMapping(col_list, row_list, aggregation_field);

            // Draw pivot table
            // 현재까지는 Column Header 개발
            var html = drawPivotTable(row_list, col_list, aggregation_field, mapping_cell, row_field, col_field)
            $("#test").html(html);

            // set result data
            for (var i in result_list){
                for (var j in result_list[i]){
                    var str = "";
                    var last_cnt = row_field.length + col_field.length;
                    var cur_cnt = 0;
                    var cell_val = "";
                    $.each(result_list[i][j], function(key, value){
                        if (cur_cnt === last_cnt){
                            str += key;
                            cell_val = value;
                        }else{
                            str += value + "_";
                        }
                        cur_cnt++;
                    });
                    $("#" + str).html(cell_val);
                }
            }

            // set datatables
            var t = $("#pivot").DataTable({
                searching: false,
                paging: true,
                lengthChange: true,
                lengthMenu: [10, 25, 50, 100, 250, 500, 1000],
                pageLength: 10,
                info: false,
                ordering: false,
                columnDefs: [{
                    searchable: false,
                    orderable: false,
                    targets: [0,1]
                }],
                footerCallback: function(row, data, start, end, display){
                    var api = this.api(), data;
                    var intVal = function ( i ) {
                        return typeof i === 'string' ?
                            i.replace(/[\$,]/g, '')*1 :
                            typeof i === 'number' ?
                                i : 0;
                    };

                    var cell_count = row_field.length + mapping_cell[0].length;

                    for (var i = 0; i < cell_count; i++){
                        var sum_col = api
                            .column(i)
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        $(api.column(i).footer()).html(sum_col);
                    }
                }
            });
        });
    </script>
</html>
