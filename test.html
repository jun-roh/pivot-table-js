<html>
    <header>
        <link rel="stylesheet" type="text/css" href="css/datatables.min.css"/>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>

        <script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/parameter.js"></script>
        <script src="js/alasql.js"></script>
        <script src="js/ala_test.js"></script>

        <script src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/datatables.min.js"></script>
        <script src="js/dataTables.rowsGroup.js"></script>
    </header>

    <style>
        table {
            width: 100%;
            border: 1px solid #000000;
        }
        th, td {
            border: 1px solid #000000;
            height: 15px;
            text-align: center;
        }

        tr.group,
        tr.group:hover {
            background-color: #ddd !important;
        }
    </style>

    <body>
        <div id="test">
        </div>
    </body>
    <script type="text/javascript">
        $(document).ready(function() {
            var row_field = ["row_val", "row_val_1"];
            var col_field = ["col_val", "col_val_1"];
            var aggregation_field = [{
                field: "revenue",
                calculate: "sum"
            },{
                field: "revenue",
                calculate: "avg"
            }]

            // pivot cell 에 넣을 data
            var result_list = getPivotQry(row_field, col_field, aggregation_field);

            // pivot row 의 distinct data
            var row_list = getDistinctQry(row_field);

            // pivot column 의 distinct data
            var col_list = getDistinctQry(col_field);

            // pivot mapping cell
            var mapping_cell = setCellMapping(col_list, row_list, aggregation_field);

            // Draw pivot table
            // 현재까지는 Column Header 개발
            var html = drawPivotTable(row_list, col_list, aggregation_field, mapping_cell, row_field, col_field)
            $("#test").html(html);

            // set result data
            for (var i in result_list){
                for (var j in result_list[i]){
                    var str = "";
                    var last_cnt = row_field.length + col_field.length;
                    var cur_cnt = 0;
                    var cell_val = "";
                    $.each(result_list[i][j], function(key, value){
                        if (cur_cnt === last_cnt){
                            str += key;
                            cell_val = value;
                        }else{
                            str += value + "_";
                        }
                        cur_cnt++;
                    });
                    $("#" + str).html(cell_val);
                }
            }



            var row_group_list = [];
            for (var i in row_field){
                row_group_list.push(i)
            }

            // set datatables
            var t = $("#pivot").DataTable({
                searching: false,
                paging: true,
                lengthChange: true,
                lengthMenu: [10, 25, 50, 100, 250, 500, 1000],
                pageLength: 10,
                info: false,
                ordering: false,
                columnDefs: [{
                    render: function (data, type, row) {
                        var sum = 0;
                        console.log(row)
                        for (var j = row_field.length; j < mapping_cell[0].length + row_field.length -1; j++){
                            sum = sum + intVal(row[j]);
                        }
                        return sum
                    },
                    targets: row_field.length + mapping_cell[0].length
                }],
                rowsGroup:row_group_list,
                drawCallback: function (settings) {
                    var api = this.api();
                    var rows = api.rows( {page:'all'} ).nodes();
                    var last = null;

                    var title_cnt = (row_field.length);
                    var data_cnt = (mapping_cell[0].length);

                    // Remove the formatting to get integer data for summation
                    var total = [];

                    api.column(0, {page:'all'}).data().each(function (group, i) {
                        var group_assoc = group.replace(' ', "_");

                        if (typeof total[group_assoc] != 'undefined'){
                            for (var j = 0; j < data_cnt + 1; j++){
                                total[group_assoc][j] = total[group_assoc][j] + intVal(api.column(j + title_cnt).data()[i])
                            }
                        }else{
                            var row_data = [];
                            for (var j = 0; j < data_cnt + 1; j++){
                                row_data.push(intVal(api.column(Number(j) + Number(title_cnt)).data()[i]))
                            }
                            total[group_assoc] = row_data
                        }

                        if (last !== group){
                            var html = '<tr class="group">'
                            html += '<td colspan="'+title_cnt+'">'+group_assoc+' Total : </td>'
                            var row_list = total[group_assoc];
                            for (var j = 0; j < data_cnt + 1; j ++){
                                html += '<td>'+row_list[j]+'</td>'
                            }
                            html += '</tr>'
                            $(rows).eq(i).before(html);
                            last = group;
                        }
                    });
                    for (var key in total){
                        $("." + key).html("$" + total[key]);
                    }
                }, footerCallback: function(row, data, start, end, display){
                    var api = this.api(), data;

                    var cell_count = row_field.length + mapping_cell[0].length;
                    var row_count = row_field.length;
                    for (var i = 3; i < cell_count + 1; i++){
                        var sum_col = api
                            .column(i)
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);
                        $(api.column(i).footer()).html(sum_col);
                    }
                }
            });

            t.footerCallback(row, data, )

            // right total
            var total_cnt = row_field.length + mapping_cell[0].length;
            var column = t.column(total_cnt);
            column.visible(column.visible());
        });


    </script>
</html>
